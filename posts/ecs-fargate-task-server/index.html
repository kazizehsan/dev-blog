<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="ECS Fargate Task as a Web server" /><meta property="og:locale" content="en" /><meta name="description" content="Photo by C Dustin on Unsplash" /><meta property="og:description" content="Photo by C Dustin on Unsplash" /><link rel="canonical" href="https://kazizehsan.github.io/posts/ecs-fargate-task-server/" /><meta property="og:url" content="https://kazizehsan.github.io/posts/ecs-fargate-task-server/" /><meta property="og:site_name" content="Kazi Ehsan Aziz" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-12-03T22:42:00+06:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="ECS Fargate Task as a Web server" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-12-03T22:42:00+06:00","datePublished":"2023-12-03T22:42:00+06:00","description":"Photo by C Dustin on Unsplash","headline":"ECS Fargate Task as a Web server","mainEntityOfPage":{"@type":"WebPage","@id":"https://kazizehsan.github.io/posts/ecs-fargate-task-server/"},"url":"https://kazizehsan.github.io/posts/ecs-fargate-task-server/"}</script><title>ECS Fargate Task as a Web server | Kazi Ehsan Aziz</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Kazi Ehsan Aziz"><meta name="application-name" content="Kazi Ehsan Aziz"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/avatar.jpeg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Kazi Ehsan Aziz</a></div><div class="site-subtitle font-italic">Software Developer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/kazizehsan" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['kazizehsan','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/kazizehsan" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>ECS Fargate Task as a Web server</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>ECS Fargate Task as a Web server</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/kazizehsan">Kazi Ehsan Aziz</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1701621720" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2023-12-03 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="992 words"> <em>5 min</em> read</span></div></div></div><div class="post-content"><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 400'%3E%3C/svg%3E" data-src="/assets/img/bg/c-dustin-K-Iog-Bqf8E-unsplash.jpg" alt="Desktop View" width="700" height="400" data-proofer-ignore> <em>Photo by <a href="https://unsplash.com/@dianamia?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash">C Dustin</a> on <a href="https://unsplash.com/photos/white-clouds-K-Iog-Bqf8E?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash">Unsplash</a></em></p><p>You can manually run a one-off ECS Fargate Task based off a Dockerized image of your API server. But if you are expecting heavy traffic, you can setup Load Balancer, Service etc. In this guide we will setup everything using CloudFormation.</p><p>Some key points to note are:</p><ul><li>we will create a Load Balancer with its own Security Group<li>we will create a Service with its own Security Group (Tasks start automatically on creation of Service)<li>we will modify Security Group (inbound rule) of Service to receive traffic from Security Group of Load Balancer</ul><blockquote class="prompt-info"><div><p>When Task Definition is revised (essentially registering the task def again) with a new ECR image tag, the old Task running in the Service is stopped and its Public IP is stripped away. After a while the Task is removed. This Public IP was actually never directly consumed since the user accesses by the Load Balancer’s IP.</p></div></blockquote><blockquote class="prompt-info"><div><p>Existing tasks and services that reference a DELETE_IN_PROGRESS task definition revision continue to run without disruption.</p></div></blockquote><blockquote class="prompt-info"><div><p>If you stop a Task managed by a Service, a new instance of the Task will start again automatically if the Service has a target of running at least 1 Task at all times.</p></div></blockquote><h2 id="prerequisites"><span class="mr-2">Prerequisites</span><a href="#prerequisites" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>In AWS Management Console, use the following settings to create a Security Group for the Load Balancer.</p><ul><li>Name: APILoadBalancerSG<li>Inbound rule:<ul><li>Type: Custom TCP<li>Protocol: TCP<li>Port range: 80<li>Source: 0.0.0.0/0</ul></ul><p>Another SG for the ECS Service.</p><ul><li>Name: APIServiceSG<li>Inbound rule:<ul><li>Type: Custom TCP<li>Protocol: TCP<li>Port range: 80<li>Source: APILoadBalancerSG</ul></ul><blockquote class="prompt-info"><div><p>These two SGs needed to be created beforehand because the API server in this example expected an RDS to preexist since alembic migrations are done on API task startup and the RDS instance needed a SG that referenced the APIServiceSG.</p></div></blockquote><h2 id="cloudformation"><span class="mr-2">CloudFormation</span><a href="#cloudformation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
</pre><td class="rouge-code"><pre><span class="na">AWSTemplateFormatVersion</span><span class="pi">:</span> <span class="s">2010-09-09</span>
<span class="na">Parameters</span><span class="pi">:</span>
  <span class="na">DeploymentEnv</span><span class="pi">:</span>
    <span class="na">Description</span><span class="pi">:</span> <span class="s">The environment for deployment</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">String</span>
    <span class="na">AllowedValues</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">prod</span>
  <span class="na">VPC</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::VPC::Id</span>
  <span class="na">SubnetA</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::Subnet::Id</span>
  <span class="na">SubnetB</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::Subnet::Id</span>
  <span class="na">ContainerSecurityGroup</span><span class="pi">:</span> <span class="c1"># the APIServiceSG created earlier</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::SecurityGroup::Id</span>
  <span class="na">LoadBalancerSecurityGroup</span><span class="pi">:</span> <span class="c1"># the APILoadBalancerSG created earlier</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::SecurityGroup::Id</span>
<span class="na">Resources</span><span class="pi">:</span>
  <span class="na">Cluster</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AWS::ECS::Cluster'</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">ClusterName</span><span class="pi">:</span> <span class="s">MyAPICluster</span>
      <span class="na">CapacityProviders</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">FARGATE</span>
  <span class="na">TaskExecutionRole</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AWS::IAM::Role'</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">RoleName</span><span class="pi">:</span> <span class="s">MyAPITaskExecutionRole</span>
      <span class="na">AssumeRolePolicyDocument</span><span class="pi">:</span>
        <span class="na">Version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2012-10-17'</span>
        <span class="na">Statement</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
            <span class="na">Principal</span><span class="pi">:</span>
              <span class="na">Service</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s">ecs-tasks.amazonaws.com</span>
            <span class="na">Action</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s1">'</span><span class="s">sts:AssumeRole'</span>
      <span class="na">Policies</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">PolicyName</span><span class="pi">:</span> <span class="s">MyAPITaskExecutionRolePolicy</span>
          <span class="na">PolicyDocument</span><span class="pi">:</span>
            <span class="na">Version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2012-10-17"</span>
            <span class="na">Statement</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
                <span class="na">Action</span><span class="pi">:</span> 
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ecr:GetAuthorizationToken'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ecr:BatchCheckLayerAvailability'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ecr:GetDownloadUrlForLayer'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ecr:BatchGetImage'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">logs:CreateLogStream'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">logs:PutLogEvents'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ssm:DescribeParameters'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ssm:GetParameterHistory'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ssm:GetParametersByPath'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ssm:GetParameters'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ssm:GetParameter'</span>
                <span class="na">Resource</span><span class="pi">:</span> <span class="s1">'</span><span class="s">*'</span>
  <span class="na">TaskRole</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::IAM::Role</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">RoleName</span><span class="pi">:</span> <span class="s">MyAPITaskRole</span>
      <span class="na">AssumeRolePolicyDocument</span><span class="pi">:</span>
        <span class="na">Statement</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
            <span class="na">Principal</span><span class="pi">:</span>
              <span class="na">Service</span><span class="pi">:</span> <span class="s">ecs-tasks.amazonaws.com</span>
            <span class="na">Action</span><span class="pi">:</span> <span class="s1">'</span><span class="s">sts:AssumeRole'</span>
      <span class="na">Policies</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">PolicyName</span><span class="pi">:</span> <span class="s">MyAPITaskRolePolicy</span>
          <span class="na">PolicyDocument</span><span class="pi">:</span>
            <span class="na">Version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2012-10-17"</span>
            <span class="na">Statement</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">Sid</span><span class="pi">:</span> <span class="s">AllowSSM</span>
                <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
                <span class="na">Action</span><span class="pi">:</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ssm:DescribeParameters'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ssm:GetParameterHistory'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ssm:GetParametersByPath'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ssm:GetParameters'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ssm:GetParameter'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ssm:PutParameter'</span>
                <span class="na">Resource</span><span class="pi">:</span> <span class="s1">'</span><span class="s">*'</span>
              <span class="pi">-</span> <span class="na">Sid</span><span class="pi">:</span> <span class="s">AllowLogs</span>
                <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
                <span class="na">Action</span><span class="pi">:</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">logs:CreateLogStream'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">logs:PutLogEvents'</span>
                <span class="na">Resource</span><span class="pi">:</span> <span class="s1">'</span><span class="s">*'</span>
              <span class="pi">-</span> <span class="na">Sid</span><span class="pi">:</span> <span class="s">AllowECR</span>
                <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
                <span class="na">Action</span><span class="pi">:</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ecr:GetAuthorizationToken'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ecr:BatchCheckLayerAvailability'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ecr:GetDownloadUrlForLayer'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ecr:BatchGetImage'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ecr:DescribeImages'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ecr:GetRepositoryPolicy'</span>
                  <span class="pi">-</span> <span class="s1">'</span><span class="s">ecr:SetRepositoryPolicy'</span>
                <span class="na">Resource</span><span class="pi">:</span>
                  <span class="pi">-</span> <span class="kt">!Sub</span> <span class="s1">'</span><span class="s">arn:aws:ecr:${AWS::Region}:${AWS::AccountId}:repository/*'</span>
  <span class="na">LogGroup</span><span class="pi">:</span> 
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::Logs::LogGroup</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">LogGroupName</span><span class="pi">:</span> <span class="s">/ecs/MyAPITaskDef</span>
      <span class="na">RetentionInDays</span><span class="pi">:</span> <span class="m">30</span>
  <span class="na">TaskDefinition</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AWS::ECS::TaskDefinition'</span>
    <span class="na">DependsOn</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">LogGroup</span>
      <span class="pi">-</span> <span class="s">TaskExecutionRole</span>
      <span class="pi">-</span> <span class="s">TaskRole</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">Family</span><span class="pi">:</span> <span class="s">MyAPITaskDef</span>
      <span class="na">ContainerDefinitions</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">EntryPoint</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">sh</span>
            <span class="pi">-</span> <span class="s1">'</span><span class="s">-c'</span>
          <span class="na">Command</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="pi">&gt;-</span>
              <span class="s">/bin/bash -c "</span>
              <span class="s">alembic upgrade head;</span>
              <span class="s">gunicorn src.main:app --workers 1 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:80 --log-level=debug --timeout=90"</span>
          <span class="na">Essential</span><span class="pi">:</span> <span class="no">true</span>
          <span class="na">Image</span><span class="pi">:</span> <span class="kt">!Join</span>
            <span class="pi">-</span> <span class="s1">'</span><span class="s">'</span>
            <span class="pi">-</span> <span class="pi">-</span> <span class="kt">!Ref</span> <span class="s">AWS::AccountId</span>
              <span class="pi">-</span> <span class="s">.dkr.ecr.</span>
              <span class="pi">-</span> <span class="kt">!Ref</span> <span class="s">AWS::Region</span>
              <span class="pi">-</span> <span class="s">.amazonaws.com/</span>
              <span class="pi">-</span> <span class="s">my-api-image:latest</span>
          <span class="na">LogConfiguration</span><span class="pi">:</span>
            <span class="na">LogDriver</span><span class="pi">:</span> <span class="s">awslogs</span>
            <span class="na">Options</span><span class="pi">:</span>
              <span class="na">awslogs-group</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">LogGroup</span>
              <span class="na">awslogs-region</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">AWS::Region</span>
              <span class="na">awslogs-stream-prefix</span><span class="pi">:</span> <span class="s">ecs</span>
          <span class="na">Name</span><span class="pi">:</span> <span class="s">MyAPIContainer</span>
          <span class="na">PortMappings</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">ContainerPort</span><span class="pi">:</span> <span class="m">80</span>
              <span class="na">Protocol</span><span class="pi">:</span> <span class="s">tcp</span>
          <span class="na">Environment</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">Name</span><span class="pi">:</span> <span class="s">ENV</span>
              <span class="na">Value</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">DeploymentEnv</span>
          <span class="na">Secrets</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">Name</span><span class="pi">:</span> <span class="s">POSTGRES_HOST</span>
              <span class="na">ValueFrom</span><span class="pi">:</span> <span class="kt">!Sub</span> <span class="s1">'</span><span class="s">/myapp/${DeploymentEnv}/db_host'</span>
            <span class="pi">-</span> <span class="na">Name</span><span class="pi">:</span> <span class="s">POSTGRES_DB</span>
              <span class="na">ValueFrom</span><span class="pi">:</span> <span class="kt">!Sub</span> <span class="s1">'</span><span class="s">/myapp/${DeploymentEnv}/db_name'</span>
            <span class="pi">-</span> <span class="na">Name</span><span class="pi">:</span> <span class="s">POSTGRES_PASSWORD</span>
              <span class="na">ValueFrom</span><span class="pi">:</span> <span class="kt">!Sub</span> <span class="s1">'</span><span class="s">/myapp/${DeploymentEnv}/db_password'</span>
            <span class="pi">-</span> <span class="na">Name</span><span class="pi">:</span> <span class="s">POSTGRES_PORT</span>
              <span class="na">ValueFrom</span><span class="pi">:</span> <span class="kt">!Sub</span> <span class="s1">'</span><span class="s">/myapp/${DeploymentEnv}/db_port'</span>
            <span class="pi">-</span> <span class="na">Name</span><span class="pi">:</span> <span class="s">POSTGRES_USER</span>
              <span class="na">ValueFrom</span><span class="pi">:</span> <span class="kt">!Sub</span> <span class="s1">'</span><span class="s">/myapp/${DeploymentEnv}/db_user'</span>
            <span class="pi">-</span> <span class="na">Name</span><span class="pi">:</span> <span class="s">AUTH0_DOMAIN</span>
              <span class="na">ValueFrom</span><span class="pi">:</span> <span class="kt">!Sub</span> <span class="s1">'</span><span class="s">/myapp/${DeploymentEnv}/auth0/domain'</span>
      <span class="na">Cpu</span><span class="pi">:</span> <span class="m">512</span>
      <span class="na">ExecutionRoleArn</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">TaskExecutionRole</span>
      <span class="na">TaskRoleArn</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">TaskRole</span>
      <span class="na">Memory</span><span class="pi">:</span> <span class="m">1024</span>
      <span class="na">NetworkMode</span><span class="pi">:</span> <span class="s">awsvpc</span>
      <span class="na">RequiresCompatibilities</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">FARGATE</span>
  <span class="na">LoadBalancer</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::ElasticLoadBalancingV2::LoadBalancer</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">LoadBalancerAttributes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">Key</span><span class="pi">:</span> <span class="s">idle_timeout.timeout_seconds</span>
          <span class="na">Value</span><span class="pi">:</span> <span class="m">60</span>
      <span class="na">Name</span><span class="pi">:</span> <span class="s">MyAPILoadBalancer</span>
      <span class="na">Scheme</span><span class="pi">:</span> <span class="s">internet-facing</span>
      <span class="na">SecurityGroups</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="kt">!Ref</span> <span class="s">LoadBalancerSecurityGroup</span>
      <span class="na">Subnets</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="kt">!Ref</span> <span class="s">SubnetA</span>
        <span class="pi">-</span> <span class="kt">!Ref</span> <span class="s">SubnetB</span>
  <span class="na">TargetGroup</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::ElasticLoadBalancingV2::TargetGroup</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">HealthCheckIntervalSeconds</span><span class="pi">:</span> <span class="m">30</span>
      <span class="na">HealthCheckPath</span><span class="pi">:</span> <span class="s">/v1/ping</span>
      <span class="na">HealthCheckTimeoutSeconds</span><span class="pi">:</span> <span class="m">6</span>
      <span class="na">UnhealthyThresholdCount</span><span class="pi">:</span> <span class="m">2</span>
      <span class="na">HealthyThresholdCount</span><span class="pi">:</span> <span class="m">2</span>
      <span class="na">Name</span><span class="pi">:</span> <span class="s">MyAPITargetGroup</span>
      <span class="na">Port</span><span class="pi">:</span> <span class="m">80</span>
      <span class="na">Protocol</span><span class="pi">:</span> <span class="s">HTTP</span>
      <span class="na">TargetGroupAttributes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">Key</span><span class="pi">:</span> <span class="s">deregistration_delay.timeout_seconds</span>
          <span class="na">Value</span><span class="pi">:</span> <span class="m">60</span>
      <span class="na">TargetType</span><span class="pi">:</span> <span class="s">ip</span>
      <span class="na">VpcId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">VPC</span>
  <span class="na">ListenerHTTP</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::ElasticLoadBalancingV2::Listener</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">DefaultActions</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">TargetGroupArn</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">TargetGroup</span>
          <span class="na">Type</span><span class="pi">:</span> <span class="s">forward</span>
      <span class="na">LoadBalancerArn</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">LoadBalancer</span>
      <span class="na">Port</span><span class="pi">:</span> <span class="m">80</span>
      <span class="na">Protocol</span><span class="pi">:</span> <span class="s">HTTP</span>
  <span class="na">Service</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AWS::ECS::Service'</span>
    <span class="na">DependsOn</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">ListenerHTTP</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">ServiceName</span><span class="pi">:</span> <span class="s">MyAPIService</span>
      <span class="na">Cluster</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">Cluster</span>
      <span class="na">DesiredCount</span><span class="pi">:</span> <span class="m">1</span>
      <span class="na">HealthCheckGracePeriodSeconds</span><span class="pi">:</span> <span class="m">60</span>
      <span class="na">LaunchType</span><span class="pi">:</span> <span class="s">FARGATE</span>
      <span class="na">LoadBalancers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">ContainerName</span><span class="pi">:</span> <span class="s">MyAPIContainer</span>
          <span class="na">ContainerPort</span><span class="pi">:</span> <span class="m">80</span>
          <span class="na">TargetGroupArn</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">TargetGroup</span>
      <span class="na">NetworkConfiguration</span><span class="pi">:</span>
        <span class="na">AwsvpcConfiguration</span><span class="pi">:</span>
          <span class="na">AssignPublicIp</span><span class="pi">:</span> <span class="s">ENABLED</span>
          <span class="na">Subnets</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="kt">!Ref</span> <span class="s">SubnetA</span>
            <span class="pi">-</span> <span class="kt">!Ref</span> <span class="s">SubnetB</span>
          <span class="na">SecurityGroups</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="kt">!Ref</span> <span class="s">ContainerSecurityGroup</span>
      <span class="na">TaskDefinition</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">TaskDefinition</span>
<span class="na">Outputs</span><span class="pi">:</span>
  <span class="na">Endpoint</span><span class="pi">:</span>
    <span class="na">Description</span><span class="pi">:</span> <span class="s">Endpoint</span>
    <span class="na">Value</span><span class="pi">:</span> <span class="kt">!Join</span> 
      <span class="pi">-</span> <span class="s1">'</span><span class="s">'</span>
      <span class="pi">-</span> <span class="pi">-</span> <span class="s">http://</span>
        <span class="pi">-</span> <span class="kt">!GetAtt</span> <span class="s">LoadBalancer.DNSName</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/guides/'>Guides</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/deployment/" class="post-tag no-text-decoration" >deployment</a> <a href="/tags/aws/" class="post-tag no-text-decoration" >aws</a> <a href="/tags/ecr/" class="post-tag no-text-decoration" >ecr</a> <a href="/tags/load-balancer/" class="post-tag no-text-decoration" >load-balancer</a> <a href="/tags/security-group/" class="post-tag no-text-decoration" >security-group</a> <a href="/tags/ecs/" class="post-tag no-text-decoration" >ecs</a> <a href="/tags/fargate/" class="post-tag no-text-decoration" >fargate</a> <a href="/tags/task/" class="post-tag no-text-decoration" >task</a> <a href="/tags/cloudformation/" class="post-tag no-text-decoration" >cloudformation</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by-nc/4.0/"> CC BY-NC 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=ECS Fargate Task as a Web server - Kazi Ehsan Aziz&amp;url=https://kazizehsan.github.io/posts/ecs-fargate-task-server/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=ECS Fargate Task as a Web server - Kazi Ehsan Aziz&amp;u=https://kazizehsan.github.io/posts/ecs-fargate-task-server/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://kazizehsan.github.io/posts/ecs-fargate-task-server/&amp;text=ECS Fargate Task as a Web server - Kazi Ehsan Aziz" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/gh-pages-jekyll-chirpy/">Jekyll, Chirpy and the Github Pages</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ecr/">ecr</a> <a class="post-tag" href="/tags/github/">github</a> <a class="post-tag" href="/tags/auth0/">auth0</a> <a class="post-tag" href="/tags/authentication/">authentication</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/blogging/">blogging</a> <a class="post-tag" href="/tags/bundle/">bundle</a> <a class="post-tag" href="/tags/chirpy/">chirpy</a> <a class="post-tag" href="/tags/cicd/">cicd</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/intro-github-actions/"><div class="card-body"> <em class="timeago small" data-ts="1701624600" > 2023-12-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>An introduction to GitHub Actions</h3><div class="text-muted small"><p> Photo by Mike Benna on Unsplash GitHub Actions is free to use for standard GitHub-hosted runners in public repositories. Concepts Each job runs-on in a fresh virtual environment Each job c...</p></div></div></a></div><div class="card"> <a href="/posts/gh-pages-jekyll-chirpy/"><div class="card-body"> <em class="timeago small" data-ts="1650783240" > 2022-04-24 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Jekyll, Chirpy and the Github Pages</h3><div class="text-muted small"><p> Github Pages lets you host Jekyll sites and Chirpy makes it even easier. Photo by Florian Bernhardt on Unsplash Prerequisites Make sure to have Ruby installed. On Mac: moncefbelyamani’s tut...</p></div></div></a></div><div class="card"> <a href="/posts/auth0-server-side-authentication/"><div class="card-body"> <em class="timeago small" data-ts="1697378700" > 2023-10-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Server side authentication with Auth0</h3><div class="text-muted small"><p> Auth0 can be daunting … at first. Photo by Micah Williams on Unsplash Your API Server handles registration and authentication So, you are coming from a traditional backend-handles-all-things...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/auth0-server-side-authentication/" class="btn btn-outline-primary" prompt="Older"><p>Server side authentication with Auth0</p></a> <a href="/posts/intro-github-actions/" class="btn btn-outline-primary" prompt="Newer"><p>An introduction to GitHub Actions</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/kazizehsan">Kazi Ehsan Aziz</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution-NonCommercial 4.0 International (CC BY-NC 4.0) License by the author.">All rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ecr/">ecr</a> <a class="post-tag" href="/tags/github/">github</a> <a class="post-tag" href="/tags/auth0/">auth0</a> <a class="post-tag" href="/tags/authentication/">authentication</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/blogging/">blogging</a> <a class="post-tag" href="/tags/bundle/">bundle</a> <a class="post-tag" href="/tags/chirpy/">chirpy</a> <a class="post-tag" href="/tags/cicd/">cicd</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
